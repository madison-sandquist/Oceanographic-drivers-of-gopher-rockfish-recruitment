# timeseries to look at it
scatter_plot <- ggplot(total_larval_SSB, aes(x = total_egg_output_lm, y = SSB))+
geom_point()
scatter_plot
# timeseries to look at it
scatter_plot <- ggplot(total_larval_SSB, aes(x = total_egg_output_lmm, y = SSB))+
geom_point()
scatter_plot
# timeseries to look at it
scatter_plot <- ggplot(total_larval_SSB, aes(x = total_egg_output_lm, y = SSB))+
geom_point()
scatter_plot
# timeseries to look at it
scatter_plot <- ggplot(total_larval_SSB, aes(x = total_egg_output_lmm, y = SSB))+
geom_point()
scatter_plot
scatter_plot2 <- ggplot(total_larval_SSB, aes(x = total_egg_output_lm, y = SSB))+
geom_point()
scatter_plot + scatter_plot2
scatter_plot2 <- ggplot(total_larval_SSB, aes(x = SSB_nofishing, y = SSB))+
geom_point()
scatter_plot + scatter_plot2
Model
egg_output_PC1_facets <- ggplot(total_larval_SSB, aes(x = Year)) +
geom_line(aes(y = SSB_nofishing, color = "No Fishing")) +
geom_point(aes(y = SSB_nofishing, color = "No Fishing")) +
geom_line(aes(y = SSB,  color = "Fishing"), linetype = "dashed") +
geom_point(aes(y = SSB,  color = "Fishing")) +
scale_color_manual(values = c("No Fishing" = "indianred",
"Fishing" = "darkblue")) +
theme_classic() +
labs(x = "Year", y = "SSB", color = "Model", title = "") +
theme(axis.text.x = element_text(angle = 45, hjust = 1))+
larger_axis_theme
scatter_plot + scatter_plot2
ssb_fishing_non <- ggplot(total_larval_SSB, aes(x = Year)) +
geom_line(aes(y = SSB_nofishing, color = "No Fishing")) +
geom_point(aes(y = SSB_nofishing, color = "No Fishing")) +
geom_line(aes(y = SSB,  color = "Fishing"), linetype = "dashed") +
geom_point(aes(y = SSB,  color = "Fishing")) +
scale_color_manual(values = c("No Fishing" = "indianred",
"Fishing" = "darkblue")) +
theme_classic() +
labs(x = "Year", y = "SSB", color = "Model", title = "") +
theme(axis.text.x = element_text(angle = 45, hjust = 1))+
larger_axis_theme
ssb_fishing_non
# timeseries to look at it
scatter_plot <- ggplot(total_larval_SSB, aes(x = total_egg_output_lmm, y = SSB))+
geom_point()
scatter_plot2 <- ggplot(total_larval_SSB, aes(x = total_egg_output_lm, y = SSB))+
geom_point()
scatter_plot3 <- ggplot(total_larval_SSB, aes(x = SSB_nofishing, y = SSB))+
geom_point()
scatter_plot + scatter_plot2 + scatter_plot3
ssb_fishing_non
scatter_plot + scatter_plot2 + scatter_plot3
data <- data.frame(
zone = factor(rep(c("High", "Medium", "Low"), each = 10)),
Number of debris = c(
data <- data.frame(
zone = factor(rep(c("High", "Medium", "Low"), each = 10)),
Number of debris = c(
data <- data.frame(
zone = factor(rep(c("High", "Medium", "Low"), each = 10)),
Number of debris = c(rnorm(100, mean = 60, sd = 10),
data <- data.frame(zone = factor(rep(c("High", "Medium", "Low"), each = 10)),
Number of debris = c(rnorm(100, mean = 60, sd = 10),
data <- data.frame(zone = factor(rep(c("High", "Medium", "Low"), each = 10)),
Number of debris = c(rnorm(100, mean = 60, sd = 10),
data <- data.frame(zone = factor(rep(c("High", "Medium", "Low"), each = 10)), Number of debris = c(rnorm(100, mean = 60, sd = 10),
data <- data.frame(zone = factor(rep(c("High", "Medium", "Low"), each = 10)),Number of debris = c(rnorm(100, mean = 60, sd = 10),
knitr::opts_chunk$set(echo = TRUE)
# --- 2) Join env monthly data to recruitment (by Year) ---
full_data <- left_join(ROMS_CUTI_environmental_all, recr_all, by = "Year")
library(tidyverse)
library(ggplot2)
library(ggeffects)
library(car)
library(broom)
library(tidyr)
library(purrr)
library(lme4)
library(lmerTest)
library(glmmTMB)
library(brms)
library(factoextra)  # For visualizing PCA results
library(DHARMa)
library(emmeans)#pairwise comparisons
library(influence.ME) #outlier
library(mgcv) #GAM
library("wesanderson")
#remotes::install_github("r4ss/r4ss")
library(FactoMineR)
library(factoextra)
library(plotly)
library(pls)
library(plsVarSel)
library(wesanderson)
library(patchwork)
library(zoo)
# --- 2) Join env monthly data to recruitment (by Year) ---
full_data <- left_join(ROMS_CUTI_environmental_all, recr_all, by = "Year")
# Combined with ROMS with cuti
ROMS_CUTI_environmental_combined_all_yr <- ROMS_output_monthly_NMSA %>%
full_join(cuti_tidy, by = c("Year", "Month", "region"))
# Load the ocean data that was produced in python
ocean <- read.csv("Data/may_july_averages_1995_2020.csv")
wind <- read.csv('Data/vwind_offshore_may_july_1995_2020.csv')
ocean_2 <- read.csv("Data/may_june_1995_2020.csv")
ocean_3 <- read.csv("Data/march_june_1995_2020.csv")
monthly_averages <- read.csv('Data/monthly_averages_1995_2020.csv')
monthly_averages_all_year <- read.csv('Data/monthly_averages_allyear_1995_2020.csv')
monthly_averages_wind_1 <- read.csv("Data/monthly_vwind_offshore_averages.csv")
monthly_averages_wind_2 <- read.csv("Data/monthly_vwind_offshore_averages_at_25km.csv")
monthy_averages_wind_allyear <- read.csv("Data/monthly_vwind_offshore_averages_all_months.csv")
monthy_averages_wind_allyear <- monthy_averages_wind_allyear %>%
mutate(Month = case_when(
Month == "January"   ~ "Jan",
Month == "February"  ~ "Feb",
Month == "March"     ~ "Mar",
Month == "April"     ~ "Apr",
Month == "May"       ~ "May",
Month == "June"      ~ "Jun",
Month == "July"      ~ "Jul",
Month == "August"    ~ "Aug",
Month == "September" ~ "Sep",
Month == "October"   ~ "Oct",
Month == "November"  ~ "Nov",
Month == "December"  ~ "Dec",
TRUE ~ Month  # keep original if no match
))
monthly_averages_all_year <- monthly_averages_all_year %>%
mutate(Month = case_when(
Month == "January"   ~ "Jan",
Month == "February"  ~ "Feb",
Month == "March"     ~ "Mar",
Month == "April"     ~ "Apr",
Month == "May"       ~ "May",
Month == "June"      ~ "Jun",
Month == "July"      ~ "Jul",
Month == "August"    ~ "Aug",
Month == "September" ~ "Sep",
Month == "October"   ~ "Oct",
Month == "November"  ~ "Nov",
Month == "December"  ~ "Dec",
TRUE ~ Month  # keep original if no match
))
wind <- wind %>%
mutate(Wind = Mean) %>%
mutate(Wind_SD = SD) %>%
select(Wind,Year,Wind_SD)
# Combine into one data frame
ROMS_outputs <- left_join(ocean, wind, by = c("Year"))
# Combine into one data frame
ROMS_output_monthly <- left_join(monthly_averages, monthly_averages_wind_2, by = c("Year", "Month"))
monthly_averages_all_year <- left_join(monthly_averages_all_year, monthy_averages_wind_allyear, by = c("Year", "Month"))
ROMS_output_monthly <- ROMS_output_monthly %>%
mutate(Month = case_match(Month,
"Feb"   ~ "Feb",
"March" ~ "Mar",
"April" ~ "Apr",
"May"   ~ "May",
"June"  ~ "Jun",
"July"  ~ "Jul"))
# March month only
march_ROMS <- monthly_averages %>%
filter(Month == "March")
march_ROMS_wind <- monthly_averages_wind_2 %>%
filter(Month == "March")
march_ROMS_outputs_ <- left_join(march_ROMS, march_ROMS_wind, by = c("Year"))
# July month only
July_ROMS <- monthly_averages %>%
filter(Month == "July")
July_ROMS_wind <- monthly_averages_wind_2 %>%
filter(Month == "July")
July_ROMS_outputs_ <- left_join(July_ROMS, July_ROMS_wind, by = c("Year"))
# Load the ocean data that was produced in python
monthly_averages_south <- read.csv('Data/monthly_averages_allyear_1995_2020_37to34p4.csv')
monthly_averages_mid <- read.csv('Data/monthly_averages_allyear_1995_2020_39to37.csv')
monthly_averages_north <- read.csv('Data/monthly_averages_allyear_1995_2020_41to39.csv')
#put into one data set
monthly_averages_spatial <- bind_rows(
monthly_averages_south %>% mutate(region = "south"),
monthly_averages_mid   %>% mutate(region = "mid"),
monthly_averages_north %>% mutate(region = "north")
) %>%
mutate(region = factor(region, levels = c("south", "mid", "north")))
# load in wind csv
monthly_wind_averages_south <- read.csv('Data/monthly_Vwind_offshore_averages_37to34p4.csv')
monthly_wind_averages_mid <- read.csv('Data/monthly_Vwind_offshore_averages_39to37.csv')
monthly_wind_averages_north <- read.csv('Data/monthly_Vwind_offshore_averages_41to39.csv')
#combined
monthly_averages_spatial_wind <- bind_rows(
monthly_wind_averages_south %>% mutate(region = "south"),
monthly_wind_averages_mid   %>% mutate(region = "mid"),
monthly_wind_averages_north %>% mutate(region = "north")
) %>%
mutate(region = factor(region, levels = c("south", "mid", "north")))
monthly_averages_spatial_wind <- monthly_averages_spatial_wind %>%
mutate(Month = case_when(
Month == "January"   ~ "Jan",
Month == "February"  ~ "Feb",
Month == "March"     ~ "Mar",
Month == "April"     ~ "Apr",
Month == "May"       ~ "May",
Month == "June"      ~ "Jun",
Month == "July"      ~ "Jul",
Month == "August"    ~ "Aug",
Month == "September" ~ "Sep",
Month == "October"   ~ "Oct",
Month == "November"  ~ "Nov",
Month == "December"  ~ "Dec",
TRUE ~ Month  # keep original if no match
))
monthly_averages_spatial <- monthly_averages_spatial %>%
mutate(Month = case_when(
Month == "January"   ~ "Jan",
Month == "February"  ~ "Feb",
Month == "March"     ~ "Mar",
Month == "April"     ~ "Apr",
Month == "May"       ~ "May",
Month == "June"      ~ "Jun",
Month == "July"      ~ "Jul",
Month == "August"    ~ "Aug",
Month == "September" ~ "Sep",
Month == "October"   ~ "Oct",
Month == "November"  ~ "Nov",
Month == "December"  ~ "Dec",
TRUE ~ Month  # keep original if no match
))
# Combine into one data frame
ROMS_output_monthly_spatial <- left_join(monthly_averages_spatial, monthly_averages_spatial_wind, by = c("Year", "Month", "region"))
ROMS_output_monthly_spatial_2 <-  ROMS_output_monthly_spatial %>%
select(!Vwind_sd)
#combined with averaged spatial scale
monthly_averages_all_year_combine  <- monthly_averages_all_year %>%
mutate(region = "all")
ROMS_output_monthly_NMSA <- rbind(ROMS_output_monthly_spatial_2, monthly_averages_all_year_combine)
# Combined with ROMS with cuti
ROMS_CUTI_environmental_combined_all_yr <- ROMS_output_monthly_NMSA %>%
full_join(cuti_tidy, by = c("Year", "Month", "region"))
cuti <- read.csv("Data/CUTI_daily.csv") %>%
select(year, month, day,X34N, X35N,X36N,X37N,X38N,
X39N,X40N,X41N) %>%
#filter(year > 1994) %>%
filter(year < 2025)
#cuti <- read.csv("Data/CUTI_daily.csv") %>%
#select(year, month, day,X34N, X35N,X36N,X37N,X38N,
#       X39N,X40N,X41N, X42N, X43N, X44N, X45N,X46N, X47N) %>%
# filter(year < 2020)
monthly_yearly_averages_lat_cuti <- cuti %>%
group_by(year) %>%
summarise(across(starts_with("X"), mean, na.rm = TRUE)) %>%
rename(Year = year)
yearly_averages_cuti <- cuti %>%
group_by(year, month) %>%
summarise(across(starts_with("X"), mean, na.rm = TRUE), .groups = "drop") %>%
mutate(
average_CUTI = rowMeans(select(., starts_with("X")), na.rm = TRUE)
) %>%
rename(Year = year) %>%
rename (Month = month)%>%
select(Month, average_CUTI, Year)
yearly_averages_cuti
yearly_averages_cuti_spatially <- cuti %>%
# 1) Average each latitude within month/year (averages over days)
group_by(year, month) %>%
summarise(across(starts_with("X"), ~ mean(.x, na.rm = TRUE)), .groups = "drop") %>%
# 2) Compute regional means and overall mean across all lats
mutate(
north_CUTI = rowMeans(select(., matches("^X(39|40|41)N$")), na.rm = TRUE),
mid_CUTI   = rowMeans(select(., matches("^X(37|38)N$")),    na.rm = TRUE),
south_CUTI = rowMeans(select(., matches("^X(34|35|36)N$")), na.rm = TRUE),
average_CUTI = rowMeans(select(., starts_with("X")), na.rm = TRUE)  # mean across ALL lats
) %>%
rename(Year = year, Month = month) %>%
select(Year, Month, north_CUTI, mid_CUTI, south_CUTI, average_CUTI) %>%
arrange(Year, Month)
library(stringr)
# 1) Monthly mean for each latitude (averaging over days)
monthly_lat <- cuti %>%
group_by(year, month) %>%
summarise(across(starts_with("X"), ~ mean(.x, na.rm = TRUE)), .groups = "drop") %>%
pivot_longer(cols = starts_with("X"), names_to = "lat_col", values_to = "CUTI") %>%
mutate(lat = as.integer(str_extract(lat_col, "\\d+"))) %>%
filter(between(lat, 34, 41))
# 2) Region means (equal weight per latitude within each region)
by_region <- monthly_lat %>%
mutate(region = case_when(
lat %in% 39:41 ~ "north",
lat %in% 37:38 ~ "mid",
lat %in% 34:36 ~ "south",
TRUE ~ NA_character_
)) %>%
filter(!is.na(region)) %>%
group_by(year, month, region) %>%
summarise(CUTI = mean(CUTI, na.rm = TRUE), .groups = "drop")
# 3) "all" = mean across all eight latitudes (matches your previous rowMeans)
overall <- monthly_lat %>%
group_by(year, month) %>%
summarise(CUTI = mean(CUTI, na.rm = TRUE), .groups = "drop") %>%
mutate(region = "all")
# Final tidy table
cuti_tidy <- bind_rows(by_region, overall) %>%
rename(Year = year, Month = month) %>%
arrange(Year, Month, factor(region, levels = c("north", "mid", "south", "all")))
cuti_tidy %>%
filter(Year > 1994)
cuti_tidy <- cuti_tidy %>%
dplyr::mutate(region = factor(region, levels = c("north", "mid", "south", "all"))) %>%
dplyr::arrange(Year, Month, region)  # uses the factor order %>%
cuti_tidy$Month <- is.factor(cuti_tidy$Month)
cuti_tidy <- bind_rows(by_region, overall) %>%
rename(Year = year, Month = month) %>%
mutate(
# region factor (if you still want it)
region = factor(region, levels = c("north", "mid", "south", "all")),
# Month as character "Jan".."Dec"
Month  = month.abb[as.integer(Month)]
) %>%
# keep chronological order after converting Month to text
arrange(Year, match(Month, month.abb), region)
# Combined with ROMS with cuti
ROMS_CUTI_environmental_combined_all_yr <- ROMS_output_monthly_NMSA %>%
full_join(cuti_tidy, by = c("Year", "Month", "region"))
ROMS_CUTI_environmental_all <- ROMS_CUTI_environmental_combined_all_yr %>%
filter(region == "all")
ROMS_CUTI_environmental_all
# --- 2) Join env monthly data to recruitment (by Year) ---
full_data <- left_join(ROMS_CUTI_environmental_all, recr_all, by = "Year")
#recommended work flow, define model directory
# this is the files from the pfmc website
model_path_quil <- "Old_stock_assessments/quillback_CA_2025"
model_path_goph <- "Old_stock_assessments/GPBY"
model_path_cop <- "Old_stock_assessments/Copper"
quil <- r4ss::SS_output(model_path_quil, printstats = FALSE)
with.covar = T
parameters <- quil$parameters
quil_recruit <- quil$recruit %>%
rename(Year = Yr)
goph <- r4ss::SS_output(model_path_goph, printstats = FALSE)
with.covar = T
parameters <- goph$parameters
goph_recruit <- goph$recruit %>%
rename(Year = Yr)
cop <- r4ss::SS_output(model_path_cop, printstats = FALSE)
with.covar = T
parameters <- cop$parameters
cop_recruit <- cop$recruit %>%
rename(Year = Yr)
# combine into single dataframe
recr_all <- bind_rows(
quil_recruit %>% mutate(species = "quil"),
goph_recruit %>% mutate(species = "goph"),
cop_recruit %>% mutate(species = "cop")
) %>%
select(species, Year, dev)
head(recr_all)
unique(recr_all$species)
# --- 2) Join env monthly data to recruitment (by Year) ---
full_data <- left_join(ROMS_CUTI_environmental_all, recr_all, by = "Year")
# --- 3) Variables to correlate with recruitment dev ---
vars_to_correlate <- c("DO_avg", "pH_avg", "Temperature_avg", "Chla_avg","CUTI", "Vwind_avg")
# --- 4) Correlations by species x month x variable ---
cor_data <- full_data %>%
pivot_longer(cols = all_of(vars_to_correlate),
names_to = "Variable", values_to = "Value") %>%
group_by(species, Variable, Month) %>%
summarise(
cor_test = list(
cor.test(Value, dev, method = "pearson", use = "complete.obs")
),
.groups = "drop"
) %>%
mutate(
correlation = map_dbl(cor_test, ~ unname(.x$estimate)),
pval        = map_dbl(cor_test, ~ .x$p.value),
t_stat      = map_dbl(cor_test, ~ unname(.x$statistic)),
significant = pval < 0.001
) %>%
select(-cor_test)
# --- 5) Order months + relabel variables ---
cor_data$Month <- factor(
cor_data$Month,
levels = c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec")
)
cor_data <- cor_data %>%
mutate(
Variable = dplyr::recode(as.character(Variable),
"DO_avg" = "DO",
"pH_avg"  = "pH",
"Temperature_avg" = "Temperature",
"Chla-avg"  = "CHL-A",
"Vwind_avg" = "Wind",
"CUTI" = "Upwelling"
),
Variable = factor(Variable, levels = c("DO","pH","Temperature","CHL-A", "Wind", "Upwelling"))
)
# --- 6) Plot: facet by species and variable ---
ggplot(cor_data, aes(x = Month, y = correlation, color = significant, group = 1)) +
geom_point(size = 3) +
geom_line(linewidth = 1) +
facet_grid(species ~ Variable) +
geom_hline(yintercept = 0, linetype = "solid", linewidth = 0.25) +
geom_hline(yintercept = c(-0.25, 0.25), linetype = "dashed", color = "black", linewidth = 0.75) +
scale_color_manual(values = c("FALSE" = "black", "TRUE" = "indianred")) +
theme_bw() +
theme(
strip.text = element_text(size = 12, face = "bold"),
axis.line = element_line(color = "black"),
legend.position = "none",
axis.title = element_text(size = 16),
axis.text = element_text(size = 14),
axis.text.x = element_text(angle = 45, hjust = 1)
) +
labs(
x = NULL,
y = "Correlation with Recruitment",
color = "Significant"
)
# --- 7) Significant months table (now includes species) ---
significant_months <- cor_data %>%
filter(significant)
significant_months
View(full_data)
# --- 2) Join env monthly data to recruitment (by Year) ---
full_data <- left_join(ROMS_CUTI_environmental_all, recr_all, by = "Year")
# --- 3) Variables to correlate with recruitment dev ---
vars_to_correlate <- c("DO_avg", "pH_avg", "Temperature_avg", "Chla_avg","CUTI", "Vwind_avg")
# --- 4) Correlations by species x month x variable ---
cor_data <- full_data %>%
pivot_longer(cols = all_of(vars_to_correlate),
names_to = "Variable", values_to = "Value") %>%
group_by(species, Variable, Month) %>%
summarise(
cor_test = list(
cor.test(Value, dev, method = "pearson", use = "complete.obs")
),
.groups = "drop"
) %>%
mutate(
correlation = map_dbl(cor_test, ~ unname(.x$estimate)),
pval        = map_dbl(cor_test, ~ .x$p.value),
t_stat      = map_dbl(cor_test, ~ unname(.x$statistic)),
significant = pval < 0.05
) %>%
select(-cor_test)
# --- 5) Order months + relabel variables ---
cor_data$Month <- factor(
cor_data$Month,
levels = c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec")
)
cor_data <- cor_data %>%
mutate(
Variable = dplyr::recode(as.character(Variable),
"DO_avg" = "DO",
"pH_avg"  = "pH",
"Temperature_avg" = "Temperature",
"Chla_avg"  = "CHL-A",
"Vwind_avg" = "Wind",
"CUTI" = "Upwelling"
),
Variable = factor(Variable, levels = c("DO","pH","Temperature","CHL-A", "Wind", "Upwelling"))
)
# --- 6) Plot: facet by species and variable ---
ggplot(cor_data, aes(x = Month, y = correlation, color = significant, group = 1)) +
geom_point(size = 3) +
geom_line(linewidth = 1) +
facet_grid(species ~ Variable) +
geom_hline(yintercept = 0, linetype = "solid", linewidth = 0.25) +
geom_hline(yintercept = c(-0.25, 0.25), linetype = "dashed", color = "black", linewidth = 0.75) +
scale_color_manual(values = c("FALSE" = "black", "TRUE" = "indianred")) +
theme_bw() +
theme(
strip.text = element_text(size = 12, face = "bold"),
axis.line = element_line(color = "black"),
legend.position = "none",
axis.title = element_text(size = 16),
axis.text = element_text(size = 14),
axis.text.x = element_text(angle = 45, hjust = 1)
) +
labs(
x = NULL,
y = "Correlation with Recruitment",
color = "Significant"
)
# --- 7) Significant months table (now includes species) ---
significant_months <- cor_data %>%
filter(significant)
significant_months
knitr::opts_chunk$set(echo = TRUE)
read.csv("/Data/monthly_averages_allyear_1995_2020_ALL_41to34p4.csv")
read.csv("Data/monthly_averages_allyear_1995_2020_ALL_41to34p4.csv")
read.csv("GitHub/Oceanographic-drivers-of-gopher-rockfish-recruitment/Data/monthly_averages_allyear_1995_2020_ALL_41to34p4.csv")
read.csv("GitHub/Oceanographic-drivers-of-gopher-rockfish-recruitment/Data/monthly_averages_allyear_1995_2020_ALL_41to34p4.csv")
setwd("~/GitHub/Oceanographic-drivers-of-gopher-rockfish-recruitment")
read.csv("Data/monthly_averages_allyear_1995_2020_ALL_41to34p4.csv")
df <- read.csv("Data/monthly_averages_allyear_1995_2020_ALL_41to34p4.csv")
library(tidyverse)
library(ggplot2)
library(car)
library(broom)
library(lme4)
library(lmerTest)
library(DHARMa)
library(emmeans) #pairwise comparisons
library(influence.ME) #outlier
library("wesanderson")
#remotes::install_github("r4ss/r4ss")
library(zoo)
df <- read.csv("Data/monthly_averages_allyear_1995_2020_ALL_41to34p4.csv")
